结论：最终一定能取到最大匹配。

可以通过递归完成构造。

Key Obeservation：总存在一个最大匹配，使得存在一个学生选到了其最喜欢的小班课。

证明：令 $(p_1,q_1),(p_2,q_2)\dots (p_k,q_k)$ 为一组最大匹配。 $r_1,r_2\dots r_k$ 分别为 $p_1,p_2\dots p_k$ 最喜欢的小班课。

若存在 $r_i$ 不为任何一个 $q_j$，那么直接将 $q_i$调整为 $r_i$ 即可。

否则 $(p_i,q_i),(p_i,r_i)$ 均连边后构成的二分图，其恰好有 $2k$ 个结点和 $2k$ 条边。而左部每个点度数为 $2$，可以重复找到右部度数为 $1$ 的点 $q_i$，删去 $p_i$ 和 $q_i$，因此会被删掉 $2$ 个点和 $2$ 条边，可以递归下去。最终一定所有点度数都为 $2$，构成若干个环。对于每个环上所有点将 $q_i$ 均调整为 $r_i$ 即可。

于是我们有如下做法：每次任意找到一个选到其最喜欢的小班课的学生，将其放入队列的第一个，将该学生删除，课容量减一，如果课容量为 $0$ 删去该课程。然后递归构造。

实际实现中，首先需要一个二分图匹配，这里的复杂度是 $O(n^3)$。上述的证明可以直接实现成构造，单次构造是 $O(n)$ 的，复杂度为 $O(n^2)$。具体实现还可以用一个小技巧，即仅保留 $(p_i,q_i),(p_i,r_i)$ 这些边之后随机顺序做二分图匹配，这样每个环有 $\frac{1}{2}$ 的顺序改变顺序，每一次匹配是 $O(n^2)$ 的，期望复杂度同样也是 $O(n^2)$ 的。